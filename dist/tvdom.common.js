"use strict";function unescapeChar(e){return unescapes[e]}function Element(e,t,n){if(!(this instanceof Element))return _.isArray(n)||null==n||(n=_.slice(arguments,2).filter(_.truthy)),new Element(e,t,n);_.isArray(t)&&(n=t,t={}),this.tagName=e,this.props=t||{},this.children=n||[],this.key=t?t.key:void 0;var r=0;_.each(this.children,function(e,t){e instanceof Element?r+=e.count:n[t]=""+e,r++}),this.count=r}function isClosed(e){return"/"===e||">"===e}function isSpace(e){return regSpace.test(e)}function parseTagName(e){if("<"!==e.currentChar())throw Error('This is not a HTML tag. HTML tag has to start with "<"');for(var t="",n=e.nextChar();n&&!isSpace(n)&&!isClosed(n);)t+=n,n=e.nextChar();return t}function parseAttributeName(e){for(var t=e.currentChar(),n="";t;){if(isSpace(t)||isClosed(t)||"="===t){e.skip(-1);break}n+=t,t=e.nextChar()}return n}function parseAttributeValue(e){var t=e.currentChar(),n=quotas.indexOf(t)>=0?t:null;n&&(t=e.nextChar());for(var r="";t;){if(n){if(t===n&&"\\"!==e.peek(-1))break;r+=t}else{if(isSpace(t)||isClosed(t))break;r+=t}t=e.nextChar()}return r}function parseAttributes(e){for(var t="",n=e.currentChar(),r={};n&&(isSpace(n)&&(n=skipBlank(e)),!isClosed(n));)t=parseAttributeName(e),"="===(n=skipBlank(e))?(skipBlank(e),r[t]=_.unescapeString(parseAttributeValue(e)),e.nextChar()):t&&!r.hasOwnProperty(t)&&(r[t]=!0);return r}function skipBlank(e){var t=null;do{t=e.nextChar()}while(t&&isSpace(t));return t}function parse$2(e){var t=new CharReader(e);return{tagName:parseTagName(t),attributes:parseAttributes(t)}}function parse(e){var t,n=[],r=-1,a=[],i={};if((e=e.trim()).replace(tagRE,function(o,s){var u,c="/"!==o.charAt(1),l=s+o.length,p=e.charAt(l);c&&(r++,!(t=parseTag(o)).voidElement&&p&&"<"!==p&&t.children.push({type:"text",content:_.unescapeString(e.slice(l,e.indexOf("<",l)))}),i[t.tagName]=t,0===r&&n.push(t),(u=a[r-1])&&u.children.push(t),a[r]=t),c&&!t.voidElement||(r--,"<"!==p&&p&&a[r].children.push({type:"text",content:_.unescapeString(e.slice(l,e.indexOf("<",l)))}))}),1!==n.length)throw new Error("Must have one root element");return toElement(n[0])}function parseTag(e){var t=parse$2(e),n=lookup[t.tagName]||"/>"===e.substring(e.length-2);return{type:"tag",name:t.tagName,voidElement:n,attrs:t.attributes,children:[]}}function toElement(e){var t=[];return e.children.forEach(function(e){"text"==e.type?t.push(e.content):t.push(toElement(e))}),Element(e.name,e.attrs,t)}function diff$2(e,t,n){function r(e){var t={index:e,type:0};h.push(t)}function a(e,t){var n={index:e,item:t,type:1};h.push(n)}function i(e){g.splice(e,1)}for(var o,s,u=makeKeyIndexAndFree(e,n),c=makeKeyIndexAndFree(t,n),l=c.free,p=u.keyIndex,f=c.keyIndex,h=[],d=[],y=0,m=0;y<e.length;){if(o=e[y],s=getItemKey(o,n))if(f.hasOwnProperty(s)){var k=f[s];d.push(t[k])}else d.push(null);else{var v=l[m++];d.push(v||null)}y++}var g=d.slice(0);for(y=0;y<g.length;)null===g[y]?(r(y),i(y)):y++;for(var x=y=0;y<t.length;){s=getItemKey(o=t[y],n);var E=g[x],C=getItemKey(E,n);if(E)if(s===C)x++;else if(p.hasOwnProperty(s)){getItemKey(g[x+1],n)===s?(r(y),i(x),x++):a(y,o)}else a(y,o);else a(y,o);y++}return{moves:h,children:d}}function makeKeyIndexAndFree(e,t){for(var n={},r=[],a=0,i=e.length;a<i;a++){var o=e[a],s=getItemKey(o,t);s?n[s]=a:r.push(o)}return{keyIndex:n,free:r}}function getItemKey(e,t){if(e&&t)return"string"==typeof t?e[t]:t(e)}function patch(e,t){dfsWalk$1(e,{index:0},t)}function dfsWalk$1(e,t,n){for(var r=n[t.index],a=e.childNodes?e.childNodes.length:0,i=0;i<a;i++){var o=e.childNodes[i];t.index++,dfsWalk$1(o,t,n)}r&&applyPatches(e,r)}function applyPatches(e,t){_.each(t,function(t){switch(t.type){case REPLACE:var n="string"==typeof t.node?document.createTextNode(t.node):t.node.render();e.parentNode.replaceChild(n,e);break;case REORDER:reorderChildren(e,t.moves);break;case PROPS:setProps(e,t.props);break;case TEXT:e.textContent?e.textContent=t.content:e.nodeValue=t.content;break;default:throw new Error("Unknown patch type "+t.type)}})}function setProps(e,t){for(var n in t)if(void 0===t[n])e.removeAttribute(n);else{var r=t[n];_.setAttr(e,n,r)}}function reorderChildren(e,t){var n=_.toArray(e.childNodes),r={};_.each(n,function(e){if(1===e.nodeType){var t=e.getAttribute("key");t&&(r[t]=e)}}),_.each(t,function(t){var a=t.index;if(0===t.type)n[a]&&n[a]===e.childNodes[a]&&e.removeChild(e.childNodes[a]),n.splice(a,1);else if(1===t.type){var i=r[t.item.key]?r[t.item.key].cloneNode(!0):"object"===_typeof(t.item)?t.item.render():document.createTextNode(t.item);n.splice(a,0,i),e.insertBefore(i,e.childNodes[a]||null)}})}function diff(e,t){var n={};return dfsWalk(e,t,0,n),n}function dfsWalk(e,t,n,r){var a=[];if(null===t);else if(_.isString(e)&&_.isString(t))t!==e&&a.push({type:patch.TEXT,content:t});else if(e.tagName===t.tagName&&e.key===t.key){var i=diffProps(e,t);i&&a.push({type:patch.PROPS,props:i}),isIgnoreChildren(t)||diffChildren(e.children,t.children,n,r,a)}else a.push({type:patch.REPLACE,node:t});a.length&&(r[n]=a)}function diffChildren(e,t,n,r,a){var i=listDiff2(e,t,"key");if(t=i.children,i.moves.length){var o={type:patch.REORDER,moves:i.moves};a.push(o)}var s=null,u=n;_.each(e,function(e,n){dfsWalk(e,t[n],u=s&&s.count?u+s.count+1:u+1,r),s=e})}function diffProps(e,t){var n,r,a=0,i=e.props,o=t.props,s={};for(n in i)r=i[n],o[n]!==r&&(a++,s[n]=o[n]);for(n in o)r=o[n],i.hasOwnProperty(n)||(a++,s[n]=o[n]);return 0===a?null:s}function isIgnoreChildren(e){return e.props&&e.props.hasOwnProperty("ignore")}var _={},unescapes={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#x27;":"'","&#x60;":"`","&#x3D;":"="},unescapeRE=/(&amp;)|(&lt;)|(&gt;)|(&quot;)|(&#x27;)|(&#x60;)|(&#x3D;)/g;_.unescapeString=function(e){return unescapeRE.test(e)?e.replace(unescapeRE,unescapeChar):e},_.type=function(e){return Object.prototype.toString.call(e).replace(/\[object\s|\]/g,"")},_.isArray=function(e){return"Array"===_.type(e)},_.slice=function(e,t){return Array.prototype.slice.call(e,t)},_.truthy=function(e){return!!e},_.isString=function(e){return"String"===_.type(e)},_.each=function(e,t){for(var n=0,r=e.length;n<r;n++)t(e[n],n)},_.toArray=function(e){if(!e)return[];for(var t=[],n=0,r=e.length;n<r;n++)t.push(e[n]);return t},_.setAttr=function(e,t,n){switch(t){case"style":e.style.cssText=n;break;case"value":var r=e.tagName||"";"input"===(r=r.toLowerCase())||"textarea"===r?e.value=n:e.setAttribute(t,n);break;default:e.setAttribute(t,n)}},Element.prototype.render=function(){var e=document.createElement(this.tagName),t=this.props;for(var n in t){var r=t[n];_.setAttr(e,n,r)}return _.each(this.children,function(t){var n=t instanceof Element?t.render():document.createTextNode(t);e.appendChild(n)}),e};var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),CharReader=function(){function e(t){classCallCheck(this,e),this.str=t,this.index=0}return createClass(e,[{key:"currentChar",value:function(){return this.str[this.index]}},{key:"currentIndex",value:function(){return this.index}},{key:"charAt",value:function(e){return this.str[e]}},{key:"nextChar",value:function(){if(this.index++,!(this.index>=this.str.length))return this.currentChar()}},{key:"peek",value:function(e){return e=void 0==e?1:e,this.str[this.index+e]}},{key:"skip",value:function(e){this.index+=e}},{key:"length",value:function(){return this.str.length}}]),e}(),quotas="\"'",regSpace=/^\s$/,tagRE=/<(?:"[^"]*"['"]*|'[^']*'['"]*|[^'">])+>/g,lookup=Object.create?Object.create(null):{};lookup.area=!0,lookup.base=!0,lookup.br=!0,lookup.col=!0,lookup.embed=!0,lookup.hr=!0,lookup.img=!0,lookup.input=!0,lookup.keygen=!0,lookup.link=!0,lookup.menuitem=!0,lookup.meta=!0,lookup.param=!0,lookup.source=!0,lookup.track=!0,lookup.wbr=!0;var makeKeyIndexAndFree_1=makeKeyIndexAndFree,diff_2=diff$2,diff_1={makeKeyIndexAndFree:makeKeyIndexAndFree_1,diff:diff_2},listDiff2=diff_1.diff,REPLACE=0,REORDER=1,PROPS=2,TEXT=3;patch.REPLACE=REPLACE,patch.REORDER=REORDER,patch.PROPS=PROPS,patch.TEXT=TEXT;var main={element:Element,parse:parse,diff:diff,patch:patch};module.exports=main;